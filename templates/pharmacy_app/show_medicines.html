{% extends 'base.html' %}

{% block title %}Available Medicines - Customer Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card text-white shadow-lg rounded-4" style="background: linear-gradient(135deg, #1d76b9, #50ade7);">
                <div class="card-body text-center py-4">
                    <h2 class="card-title">
                        <i class="fas fa-pills me-2"></i>Available Medicines
                    </h2>
                    <p class="card-text fs-5">Browse our complete medicine inventory</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="row mb-4 g-3">
        <div class="col-md-8">
            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                <input type="text" id="searchInput" class="form-control border-0 px-4" placeholder="Search medicines by name or description...">
                <button class="btn btn-primary px-4" type="button"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="col-md-4">
            <select id="filterSelect" class="form-select shadow-sm rounded-pill">
                <option value="">All Medicines</option>
                <option value="available">In Stock</option>
                <option value="low">Low Stock</option>
                <option value="expensive">Expensive (>₹50)</option>
                <option value="cheap">Affordable (<₹20)</option>
            </select>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm text-center rounded-4 border-0">
                <div class="card-body">
                    <i class="fas fa-pills fa-2x text-primary mb-2"></i>
                    <h3 class="mb-0">{{ medicines.count }}</h3>
                    <small class="text-muted">Total Medicines</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm text-center rounded-4 border-0">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3 class="mb-0" id="availableCount">{{ medicines.count }}</h3>
                    <small class="text-muted">Available</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm text-center rounded-4 border-0">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-2x text-info mb-2"></i>
                    <h3 class="mb-0" id="avgPrice">₹0</h3>
                    <small class="text-muted">Avg Price</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm text-center rounded-4 border-0">
                <div class="card-body">
                    <i class="fas fa-calendar fa-2x text-warning mb-2"></i>
                    <h3 class="mb-0" id="expiringCount">0</h3>
                    <small class="text-muted">Expiring Soon</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Medicines Grid -->
    <div class="row" id="medicinesGrid">
        {% for medicine in medicines %}
        <div class="col-lg-4 col-md-6 mb-4 medicine-item"
             data-name="{{ medicine.m_name|lower }}"
             data-description="{{ medicine.m_descr|lower }}"
             data-price="{{ medicine.m_price }}"
             data-quantity="{{ medicine.m_quantity }}"
             data-expiry="{{ medicine.m_edate|date:'Y-m-d' }}">
            <div class="card h-100 medicine-card shadow-sm rounded-4 border-0">
                <div class="card-header text-center bg-gradient-primary text-white rounded-top-4">
                    <h5 class="mb-0">{{ medicine.m_name }}</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="text-center mb-3">
                        <i class="fas fa-pills fa-3x text-white bg-primary rounded-circle p-3 shadow-sm"></i>
                    </div>
                    <p class="card-text flex-grow-1 text-muted">{{ medicine.m_descr|truncatechars:120 }}</p>

                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <strong class="text-success">₹{{ medicine.m_price }}</strong><br>
                            <small class="text-muted">per unit</small>
                        </div>
                        <div class="col-6">
                            {% if medicine.m_quantity == 0 %}
                                <span class="badge bg-danger">Out of Stock</span>
                            {% elif medicine.m_quantity < 10 %}
                                <span class="badge bg-warning text-dark">{{ medicine.m_quantity }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ medicine.m_quantity }}</span>
                            {% endif %}
                            <br><small class="text-muted">in stock</small>
                        </div>
                    </div>

                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-calendar-plus me-1"></i>Mfg: {{ medicine.m_mdate|date:"M d, Y" }}
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-calendar-times me-1"></i>Exp: {{ medicine.m_edate|date:"M d, Y" }}
                            </small>
                        </div>
                    </div>

                    <div class="mt-auto">
                        {% if medicine.m_quantity > 0 %}
                            <a href="{% url 'buy_medicine' %}" class="btn btn-gradient-primary w-100 text-white shadow-sm">
                                <i class="fas fa-shopping-cart me-2"></i>Buy Now
                            </a>
                        {% else %}
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="fas fa-times me-2"></i>Out of Stock
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Results -->
    <div id="noResults" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No medicines found</h4>
        <p class="text-muted">Try adjusting your search or filter criteria.</p>
    </div>

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary btn-lg shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
.medicine-card {
    transition: transform 0.3s, box-shadow 0.3s;
}
.medicine-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.bg-gradient-primary {
    background: linear-gradient(135deg, #1d76b9, #50ade7) !important;
}
.btn-gradient-primary {
    background: linear-gradient(135deg, #28a745, #5cd65c);
    border: none;
}
.medicine-item.hidden {
    display: none;
}
</style>

<!-- Scripts -->
<script>
// Update statistics
function updateStats() {
    const visibleItems = document.querySelectorAll('.medicine-item:not(.hidden)');
    let totalPrice = 0;
    let expiringCount = 0;
    const today = new Date();
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    visibleItems.forEach(item => {
        const price = parseFloat(item.dataset.price);
        const expiry = new Date(item.dataset.expiry);
        totalPrice += price;
        if (expiry <= thirtyDaysFromNow && expiry > today) expiringCount++;
    });

    const avgPrice = visibleItems.length ? (totalPrice / visibleItems.length).toFixed(2) : 0;
    document.getElementById('availableCount').textContent = visibleItems.length;
    document.getElementById('avgPrice').textContent = `₹${avgPrice}`;
    document.getElementById('expiringCount').textContent = expiringCount;
}

// Search
document.getElementById('searchInput').addEventListener('keyup', function() {
    const term = this.value.toLowerCase();
    const items = document.querySelectorAll('.medicine-item');
    let visibleCount = 0;
    items.forEach(item => {
        const name = item.dataset.name;
        const desc = item.dataset.description;
        if (name.includes(term) || desc.includes(term)) {
            item.classList.remove('hidden');
            visibleCount++;
        } else {
            item.classList.add('hidden');
        }
    });
    document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
    updateStats();
});

// Filter
document.getElementById('filterSelect').addEventListener('change', function() {
    const filter = this.value;
    const items = document.querySelectorAll('.medicine-item');
    let visibleCount = 0;
    items.forEach(item => {
        const price = parseFloat(item.dataset.price);
        const quantity = parseInt(item.dataset.quantity);
        let show = true;
        if (filter === 'available' && quantity <= 0) show = false;
        if (filter === 'low' && quantity >= 10) show = false;
        if (filter === 'expensive' && price <= 50) show = false;
        if (filter === 'cheap' && price >= 20) show = false;
        if (show) { item.classList.remove('hidden'); visibleCount++; } 
        else { item.classList.add('hidden'); }
    });
    document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
    updateStats();
});

// Initialize
document.addEventListener('DOMContentLoaded', updateStats);
</script>
{% endblock %}
